// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String         @id @default(cuid())
  email                  String?        @unique
  address                String         @unique
  listings               Listing[]
  auctions               Auction[]
  sentOffers             Offer[]        @relation("sentOffers")
  receivedOffers         Offer[]        @relation("receivedOffers")
  initiatedListingOffers ListingOffer[] @relation("initiatedListingOffers")
  receievedListingOffers ListingOffer[] @relation("receivedListingOffers")
  initiatedAuctionBids   AuctionBid[]   @relation("initiatedAuctionBids")
  receivedAuctionBids    AuctionBid[]   @relation("receivedAuctionBids")
}

model Listing {
  id          String         @id @default(cuid())
  creatorAddr String
  nftId       String         @unique
  price       Decimal
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt()
  offers      ListingOffer[]
  nft         NFT            @relation(fields: [tokenId], references: [nftId], onDelete: Cascade)
  creator     User           @relation(fields: [creatorAddr], references: [address], onDelete: Cascade)
}

model ListingOffer {
  id          String   @id @default(cuid())
  offerorAddr String
  offereeAddr String
  listingId   String
  amount      Decimal
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt()
  offeror     User     @relation(name: "initiatedListingOffers", fields: [offerorAddr], references: [address], onDelete: Cascade)
  offeree     User     @relation(name: "receivedListingOffers", fields: [offereeAddr], references: [address], onDelete: Cascade)
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model Auction {
  id          String       @id @default(cuid())
  creatorAddr String
  nftId       String       @unique
  duration    Decimal
  minBid      Decimal
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt()
  bids        AuctionBid[]
  nft         NFT          @relation(fields: [nftId], references: [tokenId], onDelete: Cascade)
  creator     User         @relation(fields: [creatorAddr], references: [address], onDelete: Cascade)
}

model AuctionBid {
  id           String   @id @default(cuid())
  bidderAddr   String
  receiverAddr String
  auctionId    String
  amount       Decimal
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt()
  auction      Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidder       User     @relation(name: "initiatedAuctionBids", fields: [bidderAddr], references: [address], onDelete: Cascade)
  receiver     User     @relation(name: "receivedAuctionBids", fields: [receiverAddr], references: [address], onDelete: Cascade)
}

model Offer {
  id           String   @id @default(cuid())
  senderAddr   String
  receiverAddr String
  nftId        String
  amount       Decimal
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt()
  sender       User     @relation(name: "sentOffers", fields: [senderAddr], references: [address], onDelete: Cascade)
  receiver     User     @relation(name: "receivedOffers", fields: [receiverAddr], references: [address], onDelete: Cascade)
  nft          Nft      @relation(fields: [nftId], references: [tokenId], onDelete: Cascade)
}

model Collection {
  id          String @id @default(cuid())
  taxon       Int
  name        String
  issuer      String
  description String
  nfts        Nft[]
}

model Nft {
  id           String     @id @default(cuid())
  tokenId      String     @unique
  owner        String
  imageUrl     String
  collectionId String
  attributes   Json
  listing      Listing?
  auction      Auction?
  offers       Offer[]
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
}
